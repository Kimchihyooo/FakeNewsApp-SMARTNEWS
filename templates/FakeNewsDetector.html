<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CredibilityScan Detector</title>
    
    <link rel="stylesheet" href="../static/css/FakeNewsDetectorStyle.CSS" />
    
    <link href="https://fonts.googleapis.com/css2?family=Geo:ital@0;1&family=Oswald:wght@200..700&family=Rubik:ital,wght@0,300;1,300&display=swap" rel="stylesheet">
    <style>
        /* Simple style for video error box */
        .video-error-box {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        /* Style for transcription box */
        .transcription-box {
            max-height: 150px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 12px; 
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-family: monospace;
            font-size: 0.9rem;
            color: #343a40;
            line-height: 1.5;
            margin-top: 8px;
        }
        /* ===== PASTE THE NEW CSS RULES HERE ===== */
        .lime-good {
            background-color: #dcfce7; /* Light green */
            color: #166534; /* Dark green */
            border-radius: 3px;
            padding: 1px 2px;
        }
        .lime-bad {
            background-color: #fee2e2; /* Light red */
            color: #991b1b; /* Dark red */
            border-radius: 3px;
            padding: 1px 2px;
        }
        /* Style for the 'Analyze new' link */
        .clear-analysis-link {
            display: inline-block;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #2563eb;
            text-decoration: none;
            font-weight: 500;
        }
        .clear-analysis-link:hover {
            text-decoration: underline;
        }
        /* ========================================= */
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo">
            <h1>CredibilityScan</h1>
        </div>
        <input type="checkbox" id="nav-toggle" class="nav-toggle">
        <label for="nav-toggle" class="nav-toggle-label">
            <span></span>
        </label>
        <nav class="nav-menu">
            <div class="bordnav">
                <a href="/">Home</a>
                <a href="detector">Detector</a>
                <a href="about">How to Use?</a>
            </div>
        </nav>
    </header>

    <div class="detector-container">
    
        <div class="main-content-wrapper">

            <div class="input-column">
                <div class="input-tab-bar" role="tablist" aria-label="Input mode tabs">
                    <button class="tab tab-active" data-mode="text" type="button" aria-selected="true">Text</button>
                    <button class="tab" data-mode="video" type="button" aria-selected="false">Video</button>
                </div>

                <form action="/analyze" method="post" class="form" id="analyzeForm">
                    <div class="mode mode-text">

                        {% if lime_html %}
                            <div id="lime-highlight-box" class="detector-textarea" style="overflow-y: auto; line-height: 1.6;">
                                {{ lime_html | safe }}
                            </div>
                            <textarea id="news-input" name="news_text" style="display:none;">{{ news_text }}</textarea>

                            <div class="legend-box">
                                <h4>What the Colors Mean</h4>
                                <div class="legend-item">
                                    <div class="legend-color-box legend-bad"></div>
                                    <span>= Words often associates with FAKE news.</span>
                                </div>
                            </div>

                            <a href="/detector" class="clear-analysis-link">Analyze another article</a>

                        {% else %}
                            <textarea id="news-input" name="news_text" class="detector-textarea" placeholder="Paste your news article text here to analyze...">{{ news_text | default('', true) }}</textarea>
                            
                            <div id = "word-counts" class="word-count">0 words</div>
                        {% endif %}

                        <button type="submit" class="detector-btn" id="btntext" style="margin-top: 20px;">Analyze</button>

                    </div>
                
                    <div class="mode mode-video" style="display:none;">
                        <label for="video-url" class="detector-label">Video</label>
                        <input id="video-url" name="video_url" type="url" class="detector-textarea" placeholder="https://www.youtube.com/watch?v=..." />
                        <div id="videoPreview" class="video-preview" aria-live="polite"></div>

                        {% if transcribed_text %}
                        <div style="margin-top: 16px;">
                            <h3 style="font-family: 'Rubik', sans-serif; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem;">Transcription</h3>
                            <div class="transcription-box">
                                {{ transcribed_text }}
                            </div>
                        </div>
                        {% endif %}
                        <button type="submit" class="detector-btn" id="btnvid">Analyze Video</button>
                    </div>
                </form>
            </div> <div class="results-column">

                <button type="button" class="history-trigger-btn" id="history-trigger-btn">
                    View Recent Analysis
                </button>
                {% if video_error %}
                <div class="video-error-box">
                    <strong>Video Analysis Failed:</strong>
                    <p>{{ video_error }}</p>
                </div>
                {% endif %}

                {% if video_analysis %}
                    {% if video_analysis.label == 'Likely Real' %}
                    <div class="classification" style="background-color: #f0fdf4; border-left-color: #22c55e; color: #166534;">
                        Deepfake Detection: <strong>{{ video_analysis.label }}</strong>
                        (Confidence: {{ "%.0f"|format(video_analysis.confidence * 100) }}%)
                    </div>
                {% else %}
                    <div class="classification" style="background-color: #fee2e2; border-left-color: #ad2d2d; color: #b91c1c;">
                        Deepfake Detection: <strong>{{ video_analysis.label }}</strong>
                        (Confidence: {{ "%.0f"|format(video_analysis.confidence * 100) }}%)
                    </div>
                {% endif %}
            {% endif %}

            {% if classification_text %}
                <div class="results-content" style="color: {{ colors.text_color }};">
                    
                    <h2 style="font-family: 'Rubik', sans-serif; font-weight: 600; margin-top: 0;">
                        {% if video_analysis %}
                            Transcribed Text Analysis
                        {% else %}
                            Text Analysis
                        {% endif %}
                    </h2>

                    <div class="score-box" id="scoreBox" style="background-color: {{ colors.bg_color }}; color: {{ colors.text_color }}; padding-top: 24px; padding-bottom: 24px;">
                        <h3 class="score" id="scoreLabel" style="font-size: 2.25rem; margin-bottom: 8px;">{{ score_label }}</h3>
                        
                        {% if score_label == "High Credibility" %}
                            <p style="font-size: 1rem;"><strong>Verdict:</strong> Reliable</p>
                        {% elif score_label == "Uncertain" %}
                            <p style="font-size: 1rem;"><strong>Verdict:</strong> Mixed Signals</p>
                        {% else %}
                            <p style="font-size: 1rem;"><strong>Verdict:</strong> Likely Unreliable</p>
                        {% endif %}
                    </div>

                    <div class="classification" id="classifications" style="background-color: {{ colors.bg_color }}; border-left-color: {{ colors.accent_color }};">
                        Most Likely <strong>{{ classification_text }}</strong><br>
                        Confidence: {{ model_confidence }}%
                    </div>

                    <div class="sources">
                        <h3>Supporting Sources</h3>
                        {% if supporting_articles %}
                            {% for article in supporting_articles %}
                            <div class="source-item">
                                <a href="{{ article.link }}" target="_blank" class="source-title">
                                    {{ article.title }}
                                </a>
                                <p class="source-link"><strong>{{ article.displayLink }}</strong></p>
                                <p class="source-snippet">{{ article.snippet }}</p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="source-item">
                                <p>No supporting articles were found for this article.</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="details">

                        {% if score_label == "Low Credibility" %}
                            <p>This article most likely not <strong>reliable</strong>. The model's analysis of the text (its style, phrasing, and structure) strongly resembles patterns found in known false information.</p>
                        
                        
                        {% elif score_label == "Uncertain" %}
                            <p>This article has an <strong>uncertain</strong> score, indicating mixed signals. Here's the breakdown:</p>
                            <ul>
                                <li>The model classified the text's content as <strong>{{ classification_text }}</strong>.</li>
                                <li>The external cross-reference check found <strong>{{ supporting_articles|length }} supporting article(s)</strong>.</li>
                            </ul>
                            <p>An 'Uncertain' score occurs when the model's linguistic analysis (which classified the text as 'Real') is not supported by external sources.</p>

                        {% elif score_label == "Credible" %}
                            <p>This article is <strong>credible</strong>. This assessment is based on two key factors:</p>
                            <ul>
                                <li>The model's linguistic analysis classified the text as <strong>{{ classification_text }}</strong>.</li>
                                <li>An external cross-reference check confirmed this by finding <strong>{{ supporting_articles|length }} supporting article(s)</strong> from other reputable sources.</li>
                            </ul>
                            <p>This combination of a positive model analysis and strong external verification suggests the information is reliable.</p>
                        
                        {% endif %}
                    </div>
                </div>

            {% elif not video_error %}
                <div class="results-placeholder">
                    <h3>Results will appear here</h3>
                    <p>Enter your text or video URL on the left and click "Analyze" to see the credibility assessment.</p>
                </div>
            {% endif %}
            
            </div> </div> </div> <div class="modal-overlay" id="history-modal-overlay">
        <div class="modal-content">
            
            <div class="history-container">
                <div class="modal-header">
                    <h3>Recent Analysis</h3>
                    <button class="modal-close-btn" id="history-close-btn">&times;</button>
                </div>
                
                {% if recent %}  
                    <ul class="history-list">
                        {% for item in recent %}
                            <li class="history-item">
                                <span class="history-type history-type-{{ item.type | lower }}">{{ item.type }}</span>
                                <p class="history-summary">{{ item.summary }}</p>
                                <span class="history-verdict">{{ item.verdict }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="history-empty">Your analysis history will appear here.</p>
                {% endif %} 
            </div>
            </div>
    </div>
<script>
    (function(){
        // === 1. TAB SWITCHING LOGIC ===
        const bar = document.querySelector('.input-tab-bar');
        if(!bar) return;
        
        const tabs = Array.from(bar.querySelectorAll('.tab'));
        const textMode = document.querySelector('.mode-text');
        const videoMode = document.querySelector('.mode-video');
        const analyzeForm = document.getElementById('analyzeForm');
        
        const textInput = document.getElementById('news-input');
        const videoInput = document.getElementById('video-url');

        if (!textMode || !videoMode || !analyzeForm || !textInput || !videoInput) {
            return;
        }

        function setMode(mode){
            tabs.forEach(t => {
                const active = t.getAttribute('data-mode') === mode;
                t.classList.toggle('tab-active', active);
                t.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            
            if(mode === 'video'){
                textMode.style.display = 'none';
                videoMode.style.display = 'block';
                analyzeForm.action = '/analyze-video'; 
                textInput.required = false;
                videoInput.required = true;
            } else { 
                textMode.style.display = 'block';
                videoMode.style.display = 'none';
                analyzeForm.action = '/analyze'; 
                textInput.required = true;
                videoInput.required = false;
            }
        }

        tabs.forEach(t => t.addEventListener('click', () => setMode(t.getAttribute('data-mode'))));
        setMode('text');
        
        // === 2. HISTORY MODAL LOGIC ===
        const historyTrigger = document.getElementById('history-trigger-btn');
        const modalOverlay = document.getElementById('history-modal-overlay');
        const modalCloseBtn = document.getElementById('history-close-btn');

        if (historyTrigger && modalOverlay && modalCloseBtn) {
            const openModal = () => modalOverlay.classList.add('modal-active');
            const closeModal = () => modalOverlay.classList.remove('modal-active');

            historyTrigger.addEventListener('click', openModal);
            modalCloseBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });
        }

        // === 3. "ANALYZING..." BUTTON LOGIC ===
        if (analyzeForm){
            analyzeForm.addEventListener('submit', function(e){
                const isTextMode = textMode.style.display !== 'none';
                let btn; 
                let loadingText;

                if (isTextMode) {
                    btn = document.getElementById('btntext');
                    loadingText = "Analyzing...";
                } else {
                    btn = document.getElementById('btnvid');
                    loadingText = "Analyzing Video...";
                }

                if (btn) {
                    // Prevent submission if button is disabled via script
                    if (btn.disabled) {
                        e.preventDefault(); 
                        return;
                    }
                    btn.innerText = loadingText;
                    btn.style.opacity = '0.7';
                    btn.style.pointerEvents = 'none';
                    btn.style.cursor = 'wait';
                }
            });
        }

        // === 4. WORD COUNTER & LIMITER (UPDATED) ===
        const textArea = document.getElementById('news-input');
        const countDisplay = document.getElementById('word-counts');
        const btnText = document.getElementById('btntext'); 
        
        function updateCounter(){
            if (!textArea || !countDisplay) return;
            
            const text = textArea.value.trim();
            const count = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
            
            // --- NEW LOGIC START ---
            if (count > 250) {
                // Too many words: Disable button
                // CHANGE IS HERE:
                countDisplay.innerText = count + " / 250 words (Limit exceeded)";
                countDisplay.style.color = "#dc2626"; // Red warning color
                
                if(btnText) {
                    btnText.disabled = true;
                    btnText.style.opacity = "0.5";
                    btnText.style.cursor = "not-allowed";
                    btnText.title = "Text is too long (Max 250 words)";
                }
            } else {
                // Count is OK: Enable button
                // CHANGE IS HERE:
                countDisplay.innerText = count + " / 250 words";
                countDisplay.style.color = "#6c757d"; // Reset to gray
                
                if(btnText) {
                    btnText.disabled = false;
                    btnText.style.opacity = "1";
                    btnText.style.cursor = "pointer";
                    btnText.title = "";
                }
            }
            // --- NEW LOGIC END ---
        }

        if(textArea){
            textArea.addEventListener('input', updateCounter);
            updateCounter(); // Run immediately on load
        }

    })();
</script>
</body>
</html>